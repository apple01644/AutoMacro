<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <title>나만의 매크로 만들기</title>
</head>

<body class="d-flex align-items-center min-vh-100">
    <div class="m-auto container px-3 border shadow">
        <h1 class="text-center my-3">
            나만의 매크로 만들기
        </h1>
        <div class="d-flex mb-3">

            <CommandArea class="flex-fill card p-2 mh-100">
            </CommandArea>
            <CommandPushArea class="d-flex flex-column ml-3 overflow-auto">
            </CommandPushArea>
        </div>

    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>

    <script>
        const command_types = {
            'add_global_var': 0,
            'image_search': 3,
            'keydown': 4,
            'keyup': 5,
            'mouse_click': 6,
            'sound_alarm': 8,
            'goto_group': 8,
            'delay': 10,
        }
        const able_key_list = {
            'a': 'A',
            'b': 'B',
            'c': 'C',
            'd': 'D',
            'e': 'E',
            'f': 'F',
            'g': 'G',
            'h': 'H',
            'i': 'I',
            'j': 'J',
            'k': 'K',
            'l': 'L',
            'm': 'M',
            'n': 'N',
            'o': 'O',
            'p': 'P',
            'q': 'Q',
            'r': 'R',
            's': 'S',
            't': 'T',
            'u': 'U',
            'v': 'V',
            'w': 'W',
            'x': 'X',
            'y': 'Y',
            'z': 'Z',
        }
        const able_mouse_button_list = {
            '왼쪽' :'left',
            '가운데쪽' :'middle',
            '오른쪽' :'right',
        }

        var stateChanged = true;
        var state = {
            command_push: {
                '전역 변수 추가': {
                    enable: false,
                    type: command_types.add_global_var,
                },
                '이미지 서치 추가': {
                    enable: false,
                    type: command_types.image_search,
                },
                '키다운 추가': {
                    enable: true,
                    type: command_types.keydown,
                },
                '키 업 추가': {
                    enable: true,
                    type: command_types.keyup,
                },
                '마우스 클릭': {
                    enable: true,
                    type: command_types.mouse_click,
                },
                '사운드 알람': {
                    enable: false,
                    type: command_types.sound_alarm,
                },
                '그룹 전환': {
                    enable: false,
                    type: command_types.goto_group,
                },
                '시간 지연': {
                    enable: true,
                    type: command_types.delay,
                },
            },
            groups: {
                '메인': {
                    command_blocks: []
                },
                '서브루틴': {
                    command_blocks: []
                }
            },
            focused_group_name: null,
            running_line_number: null,
        };

        render = () => {
            const CommandArea = $('CommandArea');
            const CommandPushArea = $('CommandPushArea');

            CommandPushArea.html(`
            <div class="btn-group">
                <label class="btn border-secondary text-muted">x = 0</label>
                <label class="btn border-secondary text-muted">y = 0</label>
            </div>`);
            for (const commnad_push_name in state.command_push)
                CommandPushArea.append(CommandPush_render(commnad_push_name));

            CommandArea.empty();
            for (const group_name in state.groups) {
                CommandArea.append(Group_render(group_name, state.groups[group_name]));
            }
        };


        loop = () => {
            if (stateChanged) {
                render();
                stateChanged = false;
            }
        };

        setState = (dict) => {
            state = Object.assign({}, state, dict);
            stateChanged = true;
        }

        $(document).ready(() => {
            setInterval(loop, 100);
        });

        get_target_value = (target, key) => {
            return target.currentTarget.attributes[key].textContent;
        }

        const CommandBlock = {
            mutation: (data, dom = null) => {
                let result = {
                    type: data.type,
                    data: data
                };
                if (data.type == command_types.keydown) {
                    result.key = data.key || Object.keys(able_key_list)[0]
                }
                else if (data.type == command_types.keyup) {
                    result.key = data.key || Object.keys(able_key_list)[0]
                }
                else if (data.type == command_types.mouse_click) {
                    result.button = data.button || Object.keys(able_mouse_button_list)[0]
                }
                return result;
            },
            render : (command_block, group_name, line_number) => {
                let CB_dom = $(`
                        <CommandBlock class="border mt-2 form-inline py-2 d-flex">
                        </CommandBlock>`);
                if (group_name === state.focused_group_name && line_number === state.running_line_number)
                    CB_dom.append(icon_triangle_right)
                else
                    CB_dom.append($('<label class="mx-1 font-weight-bold text-muted">' + line_number +
                        '</label>'));
                if (command_block.type == command_types.keydown) {
                    CB_dom.append($('<label class="text-dark">키 다운</label>'))
                    CB_dom.append(select_able_key_list().addClass('ml-auto').on(
                        'click',
                        (e) => {
                            e.preventDefault();
                        }
                    ));
                }
                else if (command_block.type == command_types.keyup) {
                    CB_dom.append($('<label class="text-dark">키 업</label>'))
                    CB_dom.append(select_able_key_list().addClass('ml-auto').on(
                        'click',
                        (e) => {
                            e.preventDefault();
                        }
                    ));
                }
                else if (command_block.type == command_types.mouse_click) {
                    CB_dom.append($('<label class="text-dark">마우스 클릭</label>'))
                    CB_dom.append(select_able_mouse_button_list().addClass('ml-auto').on(
                        'click',
                        (e) => {
                            e.preventDefault();
                        }
                    ));
                }
                else {
                    CB_dom.append($('<label class="text-dark">알 수 없는 명령어 [' + command_block.type +']</label>'))
                }

                return CB_dom
            },
        };

        Group_render = (group_name, group_data) => {
            group_onclick = (target) => {
                setState({
                    focused_group_name: get_target_value(target, 'value')
                });
            }

            let group = $(`
            <Group class="card p-2 mb-2" value="` + group_name + `">
                <h5>
                    그룹 ` + group_name + `
                </h5>
                <List class="d-flex flex-column">
                </List>
            </Group>`)

            if (group_name === state.focused_group_name)
                group.addClass('border-primary')
                .addClass('text-primary');
            else
                group.click(group_onclick);
            let line_number = 1;
            for (const command_block of group_data.command_blocks) {
                console.log(command_block);
                group.find('List').append(CommandBlock.render(command_block, group_name, line_number++));
            }
            return group;
        };
            
        CommandPush_render = (command_push_name) => {
            const command_push_data = state.command_push[command_push_name];
            command_push_onclick = (target) => {
                const command_push_name = get_target_value(target, 'value');
                const command_push_data = state.command_push[command_push_name];
                if (command_push_data.enable === false) {
                    alert('미구현된 기능입니다.')
                    return;
                }
                if (state.focused_group_name === null) {
                    alert('group을 선택해야 합니다')
                    return;
                }
                let groups = state.groups;
                groups[state.focused_group_name].command_blocks.push(
                    CommandBlock.mutation(command_push_data)
                );
                setState({
                    groups: groups
                });
            }
            let CommandPush = $(`
                <CommandPush type="button" class="btn btn-outline-primary my-2" value="` + command_push_name + `">
                    ` + command_push_name + `
                </CommandPush>
                `)
            if (command_push_data.enable)
                CommandPush.addClass('btn-outline-primary');
            else
                CommandPush.addClass('btn-outline-secondary');
            CommandPush.click(command_push_onclick);
            return CommandPush;
        }


        icon_triangle_right = () => {
            return $(`
            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-caret-right-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.14 8.753l-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
            </svg>`);
        }

        icon_triangle_down = () => {
            return $(
                `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M11.646 15.146L5.854 9.354a.5.5 0 01.353-.854h11.586a.5.5 0 01.353.854l-5.793 5.792a.5.5 0 01-.707 0z"></path></svg>`
            );
        }

        select_able_key_list = () => {
            let select = $('<select class="form-control"/>');
            for (const key in able_key_list)
                select.append($('<option></option>').attr({
                    value: key
                }).text(able_key_list[key]))
            return select
        }

        select_able_mouse_button_list = () => {
            let select = $('<select class="form-control"/>');
            for (const key in able_mouse_button_list)
                select.append($('<option></option>').attr({
                    value: key
                }).text(able_mouse_button_list[key]))
            return select
        }
    </script>
</body>

</html>